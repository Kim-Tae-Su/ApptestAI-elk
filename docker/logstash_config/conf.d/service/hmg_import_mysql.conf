input {
  jdbc {
    jdbc_driver_library => "/usr/share/java/mysql-connector-java-8.0.28.jar"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://db.apptest.ai:3306/testEx"
    jdbc_user => "tExUser"
    jdbc_password => "tnseoqhRdma2!dlsqns"
    jdbc_paging_enabled => true
    # 현재 스케줄 (15분마다)
    schedule => "0,15,30,45 * * * * Asia/Seoul"
    # 임시 스케줄
    # schedule => "55 14 * * * Asia/Seoul"
    # schedule => "* * * * * Asia/Seoul"
    statement => "SELECT * FROM view_hmg_dashboard"
  }
}

filter {
  #########################
  # 1. Logstash 처리 시간 기록
  #########################
  mutate {
    add_field => { "logstash_processed_at" => "%{+YYYY-MM-dd HH:mm:ss.SSS Z}" }
  }

  ruby {
    code => '
      event.set("logstash_processed_at_kst", (Time.now.getlocal("+09:00")).strftime("%Y-%m-%d %H:%M:%S.%L"))
    '
  }

  #########################
  # 2. 기본 필드 정리 및 파싱
  #########################
  mutate {
    convert => {
      "created_at" => "string"
      "pid" => "string"
    }
    strip => ["pid"]
    gsub => [
      "device", "_HKM\\w*", "",
      "device", "Apple", "",
      "device", "SAMSUNG", "",
      "device", "LGE", "",
      "device", "\\s", "",
      "device", "_", " ",
      "scn_type", "_stool", "",
      "scn_type", "_", " "
    ]
    split => { "device" => "/" }
    add_field => {
      "os_version" => "%{[device][1]}"
      "device_name" => "%{[device][0]}"
      "os_app_version" => "%{os} %{app_version}"
    }
    remove_field => ["device"]
  }

  mutate {
    strip => ["device_name", "os_version"]
  }

#########################
# 3. brand_name 설정 (test_suite_name 우선, 없으면 app_name 확인)
# 우선순위: HOA > KOA > GOA
#########################
# 3-1) test_suite_name 우선 매칭 (대소문자 무시)
if [test_suite_name] and ([test_suite_name] =~ /(?i)hyundai/) {
  mutate { add_field => { "brand_name" => "HOA" } }
} else if [test_suite_name] and ([test_suite_name] =~ /(?i)kia/) {
  mutate { add_field => { "brand_name" => "KOA" } }
} else if [test_suite_name] and ([test_suite_name] =~ /(?i)genesis/) {
  mutate { add_field => { "brand_name" => "GOA" } }

# 3-2) test_suite_name에 없을 때만 app_name 확인
} else if "HOA" in [app_name] {
  mutate { add_field => { "brand_name" => "HOA" } }
} else if "KOA" in [app_name] {
  mutate { add_field => { "brand_name" => "KOA" } }
} else if "GOA" in [app_name] {
  mutate { add_field => { "brand_name" => "GOA" } }

# 3-3) 매칭 실패시 기본값
} else {
  mutate { add_field => { "brand_name" => "Unknown" } }
}

  #########################
  # 4. is_crash → is_crashed 변환
  #########################
  translate {
    source => "is_crash"
    target => "is_crashed"
    dictionary => {
      "1" => "Crash"
      "0" => "X"
    }
    remove_field => ["is_crash"]
  }

  #########################
  # 5. created_at → @timestamp 변환
  #########################
  date {
    match => ["created_at", "ISO8601"]
    timezone => "Asia/Seoul"
    target => "@timestamp"
  }

  #########################
  # 6. ctime → ctimestamp 변환
  #########################
  date {
    match => ["ctime", "HH:mm:ss"]
    timezone => "Asia/Seoul"
    target => "ctimestamp"
    remove_field => ["ctime"]
  }

  #########################
  # 7. created_at_kst_str 생성
  #########################
  ruby {
    code => '
      begin
        created = event.get("created_at")
        if created
          kst = Time.parse(created.to_s).getlocal("+09:00")
          event.set("created_at_kst_str", kst.strftime("%Y-%m-%d %H:%M:%S"))
        end
      rescue => e
        event.tag("created_at_kst_str_error")
        event.set("debug_error_created_kst", e.message)
      end
    '
  }

  #########################
  # 8. finished_at_kst_str 생성
  #########################
  ruby {
    code => '
      begin
        finished = event.get("finished_at")
        if finished
          kst = Time.parse(finished.to_s).getlocal("+09:00")
          event.set("finished_at_kst_str", kst.strftime("%Y-%m-%d %H:%M:%S"))
        end
      rescue => e
        event.tag("finished_at_kst_str_error")
        event.set("debug_error_finished_kst", e.message)
      end
    '
  }

  #########################
  # 9. os_app_version_date 생성
  # 예: "iOS 0.134.0 | 2025-07-24 15:56"
  #########################
  ruby {
    code => '
      begin
        created = event.get("created_at")
        os = event.get("os") || ""
        ver = event.get("app_version") || ""
        if created
          kst = Time.parse(created.to_s).getlocal("+09:00")
          event.set("os_app_version_date", "#{os} #{ver} | #{kst.strftime("%Y-%m-%d %H:%M")}")
        end
      rescue => e
        event.tag("os_app_version_date_error")
        event.set("debug_error_os_app", e.message)
      end
    '
  }

  #########################
  # 10. date_brand_app_version 생성
  # 예: "2025-07-24 15:56 | KOA 0.134.0"
  #########################
  ruby {
    code => '
      begin
        created = event.get("created_at")
        brand = event.get("brand_name") || ""
        ver = event.get("app_version") || ""
        if created && !brand.empty? && !ver.empty?
          kst = Time.parse(created.to_s).getlocal("+09:00")
          event.set("date_brand_app_version", "#{kst.strftime("%Y-%m-%d %H:%M")} | #{brand} #{ver}")
        end
      rescue => e
        event.tag("date_brand_app_version_error")
        event.set("debug_error_dbav", e.message)
      end
    '
  }

  #########################
  # 11. is_ci → is_ci_test 변환 후 원본 제거
  #########################
  ruby {
    code => '
      begin
        is_ci_val = event.get("is_ci")
        if is_ci_val
          # 숫자든 문자열이든 상관없이 처리
          if is_ci_val.to_s.strip == "1"
            event.set("is_ci_test", "CI")
          else
            event.set("is_ci_test", "X")
          end
        else
          event.set("is_ci_test", "X")
        end

        # 원본 is_ci 필드 제거
        event.remove("is_ci")
      rescue => e
        event.tag("is_ci_conversion_error")
        event.set("debug_error_is_ci", e.message)
        event.set("is_ci_test", "X")
        event.remove("is_ci")
      end
    '
  }
}

output {
  elasticsearch {
  	hosts => ["https://localhost:9200"]
		ssl => true
		cacert => "/usr/share/logstash/config/certs/http_ca.crt"
    user => "elastic"
    password => "embian1001"
    index => "hmg"
    ilm_enabled => false
    document_id => "%{[id]}"
  }

  # 디버깅용 (필요 시 주석 해제)
  # stdout {
  #   codec => rubydebug { metadata => false }
  # }
}